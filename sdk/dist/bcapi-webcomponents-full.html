<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-button">
    <template>
        <content></content>
    </template>
    
    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>
    <script type="text/javascript" src="/src/webcomponents/buttons/button.js"></script>

    <script type="text/javascript">
    Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-piechart">
    <template>
        <div id="chart_div"></div>
    </template>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script type="text/javascript">
        var webComponent = {
            is: "bc-piechart",
            properties: {
                width: Number,
                height: Number,
                title: String,
                dataSource: {
                    type: Object,
                    observer: "_onDataSourceUpdate"
                },
                supportsDataSource: {
                    type: Boolean,
                    value: true
                }
            }
        };

        webComponent = BCAPI.Components.ComponentsFactory.get(webComponent);

        $.extend(webComponent, {
            attached: function() {
                this.__base.attached.apply(this);
                
                var self = this;

                google.load("visualization", "1.0", {
                    "packages": ["corechart"],
                    "callback": function() {
                        self._drawChart();          
                        self.dataSource = Polymer.dom(self).querySelector("[rel='datasource']");
                    }
                });
            },
            _onDataSourceUpdate: function(dataSource) {
                var loader = dataSource.list(),
                    self = this;

                loader.then(function(data) {
                    self._data.addRows(data.items);

                    var chart = new google.visualization.PieChart(self.$.chart_div);
                    chart.draw(self._data, self._chartOptions);
                });
            },
            _drawChart: function() {
                this._data = new google.visualization.DataTable();
                this._wireColumnsFromMarkup();

                this._chartOptions = {
                    "title": this.title,
                    "width": this.width || 800,
                    "height": this.height || 600
                };
            },
            _wireColumnsFromMarkup: function() {
                var bcCols = Polymer.dom(this).querySelector("bc-columns");

                if (!bcCols) {
                    return;
                }

                var cols = bcCols.querySelectorAll("[rel='dimension']"),
                    self = this;

                $(cols).each(function(colIdx, column) {
                    self._data.addColumn(column.getAttribute("data-type"), column.getAttribute("data-id"));
                });
            }
        });

        Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-datagrid-customtpl">
    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
        var webComponent = {
            "is": "bc-datagrid-customtpl",
            "properties": {
                item: {
                    type: Object,
                    notify: true,
                    observer: "changedItem"
                },
                col: Object,
                template: {
                    type: String,
                    notify: true
                },
                containsBindings: {
                    type: Boolean,
                    notify: true,
                    observer: "changedContainsBindings"
                }
            },
            ready: function() {
                var content = this._getContentElement(),
                    self = this;

                this.domBind = document.createElement('template', 'dom-bind');
                this.domBind.set("item", this.item);
                this.domBind.set("col", this.col);
                this.domBind.getItemValue = function(item, property) {
                    return self.getItemValue(item, property);
                }

                this._refreshDom(content);

                Polymer.dom(this).appendChild(this.domBind);
            },
            getItemValue: function(item, itemProperty) {
                var propertyParts = itemProperty.split(".");

                for (var idx = 0; idx < propertyParts.length; idx++) {
                    item = item[propertyParts[idx]];

                    if (item === undefined || item === null) {
                        return;
                    }
                }

                return item;
            },
            changedItem: function(newItem) {
                if (!this.domBind) {
                    return;
                }

                this.domBind.set("item", newItem);
            },
            changedContainsBindings: function(containsBindings) {
                var content = this._getContentElement();

                this._refreshDom(content);
            },
            _getContentElement: function() {
                if (!this.template) {
                    return;
                }

                var content = document.createElement("div"),
                    template = this.template,
                    self = this;

                if (this.containsBindings) {
                    template = template.replace("\\{\\{", "{{").replace("\\}\\}", "}}");
                }

                content.innerHTML = template;

                return content;
            },
            _refreshDom: function(content) {
                if (!this.domBind) {
                    return;
                }

                if (this._formerContent) {
                    this.domBind.content.removeChild(this._formerContent);
                }

                if (!content) {
                    return;
                }

                this.domBind.content.appendChild(content);

                this._formerContent = content;
            }
        };

        webComponent = BCAPI.Components.ComponentsFactory.get(webComponent);

        Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-datagrid"> 
    <style>
        .bc-datagrid-table {
            display: table;
            width: 100%;
        };
        .bc-datagrid-thead {
            display: table-header-group;
            font-weight: bold;
        };
        .bc-datagrid-tbody {
            display: table-row-group;
        };
        .bc-datagrid-tr {
            display: table-row;
        };
        .bc-datagrid-td {
            display: table-cell;
        };
        /* mimic bootstrap */
        :host .bc-datagrid-table > .bc-datagrid-thead> .bc-datagrid-tr:first-child > .bc-datagrid-td {
            border-top: 0;
        }
        :host .bc-datagrid-table > .bc-datagrid-thead > .bc-datagrid-tr > .bc-datagrid-td {
            padding: 8px;
            line-height: 1.42857143;
            vertical-align: top;
            border-top: 1px solid #ddd;
        }
        :host .bc-datagrid-table > .bc-datagrid-tbody > .bc-datagrid-tr > .bc-datagrid-td {
            padding: 8px;
            line-height: 1.42857143;
            vertical-align: top;
            border-top: 1px solid #ddd;
        }
        :host .bc-datagrid-hidden-tr {
            border: 0;
            display: table-row;
        };

    </style>
    <template>
        <content></content>

        <template is="dom-if" if="{{visible}}">
        <div class="panel panel-default">
            <div class="bc-datagrid-table table">
                <div class="bc-datagrid-thead">
                    <div class="bc-datagrid-tr">
                        <div class="bc-datagrid-td">Displaying <span>{{rows.length}}</span> out of <span>{{currData.totalItemsCount}}</span> records.</div>
                    </div>
                    <div class="bc-datagrid-tr">
                    <template is="dom-repeat" items="{{columns}}" as="colItem">
                        <div class="bc-datagrid-td">{{colItem.name}}</div>
                    </template>
                    </div>
                </div>

                <div class="bc-datagrid-tbody">
                    <template is="dom-repeat" items="{{rows}}" as="itemRow" index-as="itemIndex">
                        <div class="bc-datagrid-tr">
                            <template is="dom-repeat" items="{{columns}}" as="col">
                                <div class="bc-datagrid-td">
                                    <bc-datagrid-customtpl item$="{{itemRow}}" col$="{{col}}" template$="{{col.template}}" contains-bindings$ style$="{{col.style}}"></bc-datagrid-customtpl>
                                </div>
                            </template>
                        </div>

                        <template is="dom-if" if="{{repeatedRow}}">
                            <div class="bc-datagrid-hidden-tr">
                                <div class="bc-datagrid-td">
                                    <bc-datagrid-customtpl item$="{{itemRow}}" template$="{{repeatedRow}}" contains-bindings$></bc-datagrid-customtpl>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
        </div>
        </template>
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>
    <script type="text/javascript" src="/src/webcomponents/datagrid/datagrid.js"></script>

    <script>
    Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-json">
    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>
    <script type="text/javascript" src="/src/webcomponents/datasources/datasource.js"></script>
    <script type="text/javascript" src="/src/webcomponents/datasources/json.js"></script>

    <script>
    Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-api">
    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>
    <script type="text/javascript" src="/src/webcomponents/datasources/datasource.js"></script>
    <script type="text/javascript" src="/src/webcomponents/datasources/api.js"></script>

    <script>
    Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-select">
    <style type="text/css">
        .select-model {
            display: none;
        }
    </style>

    <template>
        <div id="selectModel" class="select-model">
            <content></content>
        </div>

        <select class$="{{class}}" id="ddItemsHolder" on-change="_handleChange"></select>
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>
    <script type="text/javascript" src="/src/webcomponents/dropdown/dropdown.js"></script>

    <script>
    Polymer(webComponent);
    </script>
</dom-module><link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-textfield">
    <style type="text/css">
        button {
            float: left;
            width: 5%;
            min-width: 40px;
        }

        input[type="text"] {
            float: left;
            width: 85%;
        }
    </style>

    <template>
        <template is="dom-if" if="{{hasSearchButton}}">
            <button type="button" class="btn btn-primary" on-click="handleSearch" disabled>
                <span class="glyphicon glyphicon-search"></span>
            </button>
        </template>

        <input type="text" class="form-control" on-keyup="handleChange" placeholder="{{placeholder}}" style="float: left;" />
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
    /**
     * This class provides a text field component which has BC look & feel. Moreover, the text field benefit from a quick search button
     * which can be activated in cases where textfield is used as full text search.
     * 
     * @name TextField
     * @class
     * @public
     * @memberof BCAPI.Components
     */
    polymerObj = {
        is: "bc-textfield",
        properties: {
            placeholder: {
                type: String,
                value: "Type your text here ..."
            },
            hasSearchButton: {
                type: Boolean,
                value: false,
                readOnly: false,
                reflectToAttribute: true
            },
            value: {
                type: String,
                readonly: true
            }
        },
        customEvents: [
            "textfieldChange", "textfieldSearch"
        ]
    };

    polymerObj = BCAPI.Components.ComponentsFactory.get(polymerObj);

    $.extend(polymerObj, {
        attached: function() {
            this.__base.attached.apply(this);
        },
        ready: function() {
             this._wireCustomEventsFromDom();
        },
        handleChange: function(evt) {
            var newValue = evt.target.value.trim(),
                disabled = !(newValue && newValue.length > 0);

            $(this).find("button").prop("disabled", disabled);

            this.value = newValue;

            if (evt.keyCode !== 13) {
                this.trigger("textfield-change", {"value": newValue});
            }

            if (!disabled && evt.keyCode === 13) {
                this.handleSearch();

                return;
            }
        },
        handleSearch: function(evt) {
            this.trigger("textfield-search", {"value": this.value});
        }
    });

    Polymer(polymerObj);
    </script>

</dom-module>