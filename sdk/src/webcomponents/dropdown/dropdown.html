<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-select">
    <style type="text/css">
        .select-model {
            display: none;
        }
    </style>

    <template>
        <div id="selectModel" class="select-model">
            <content></content>
        </div>

        <select class="form-control" id="ddItemsHolder" on-change="handleChange"></select>
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
    var webComponent = {
        is: "bc-select",
        properties: {
            items: {
                type: Array,
                notify: true,
                observer: "_refreshItemsSelect"
            },
            valueProp: {
                type: String,
                default: "value"
            },
            textProp: {
                type: String,
                default: "text"
            },
            _dataSource: {
                type: Object,
                notify: true,
                observer: "_buildFromDataSource"
            },
            _expectsDataSource: {
                type: Boolean
            }
        },
        ready: function() {
            var options = this.$.selectModel.querySelectorAll("option"),
                dataSource = this.$.selectModel.querySelector("*[rel='datasource']"),
                items;

            if (options.length > 0) {
                items = this._buildFromMarkup(options);

                this.configure({"items": items});
            }

            if (dataSource) {
                this._supportsDataSource = true;
            }

            if (dataSource && dataSource.configure) {
                this._dataSource = dataSource;
            }
        },
        getValue: function() {
            return this.items[this.$.ddItemsHolder.selectedIndex];
        },
        handleChange: function(evt) {
            var selectedItem = this.getValue();

            this.trigger("dd:change", selectedItem);
        },
        configure: function(opts) {
            var legacyBcConfig = this._bcConfig;

            this.items = opts.items || this.items;
            this._dataSource = opts.dataSource || this._dataSource;
            this._bcConfig = opts.bcConfig || this._bcConfig;

            if (this._bcConfig && this._dataSource) {
                this._dataSource.configure({"bcConfig": this._bcConfig});
            }

            if (this._bcConfig && this._bcConfig != legacyBcConfig && this._dataSource) {
                this._buildFromDataSource(this._dataSource);
            }
        },
        _buildFromMarkup: function(options) {
            var items = [];

            for (var idx = 0; idx < options.length; idx++) {
                var option = options[idx],
                    item = {"value": option.value, "text": option.text};

                items.push(item);
            }

            return items;
        },
        _buildFromDataSource: function(dataSource) {
            var loader = dataSource.fetchData(),
                self = this;

            if (!loader) {
                return;
            }

            loader.done(function(data) {
                self._fetched = true;
                self._updateData(data);
            });
        },
        _updateData: function(data) {
            var items = data.items,
                rows = [];

            for (var idx = 0; items && idx < items.length; idx++) {
                var row = {},
                    item = items[idx];

                row["value"] = item[this.valueProp];
                row["text"] = item[this.textProp];

                rows.push(row);
            }

            this.configure({"items": rows});
        },
        _refreshItemsSelect: function(items) {
            var select = this.$.ddItemsHolder;
            
            select.options.length = 0;

            for (var i = 0; i < items.length; i++) {
                var option = document.createElement("option");
                option.value = items[i].value;
                option.innerHTML = items[i].text;

                select.add(option);
            }
        } 
    };

    webComponent = BCAPI.Components.ComponentsFactory.get(webComponent);

    BCAPI.Components.DropDown = Polymer(webComponent);
    </script>
</dom-module>