<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-datagrid">
    <template>
    <div class="panel panel-default">
        <content></content>
        <table class="table" id="dataTable">
            <thead>
                <tr>
                    <td colspan="{{columns.length}}">Displaying <span>{{rows.length}}</span> out of <span>{{currData.totalItemsCount}}</span> records.</td>
                </tr>
                <tr>
                <template is="dom-repeat" items="{{columns}}">
                    <td>{{item.name}}</td>
                </template>
                </tr>
            </thead>

            <tbody>
                <template is="dom-repeat" items="{{rows}}" as="itemRow">
                <tr>
                    <template is="dom-repeat" items="{{columns}}" as="col">
                        <td>
                            <bc-datagrid-customtpl item="{{itemRow}}" col="{{col}}"></bc-datagrid-customtpl>
                        </td>
                    </template>
                </tr>
                </template>
            </tbody>
        </table>
    </div>
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
    var polymerObj = {
        is: "bc-datagrid",
        properties: {
            columns: Array,
            rows: Array,
            apiName: String,
            apiVersion: String,
            bcConfig: Object,
            currData: {
                type: Object,
                readonly: true
            }
        },
        ready: function() {
            this._dataSource = Polymer.dom(this).querySelector("*[rel='datasource']");
        },
        configure: function(opts) {
            opts = opts || {};

            this.bcConfig = opts.bcConfig || this.bcConfig || {};

            this._dataSource.configure({"bcConfig": this.bcConfig});

            this.columns = opts.columns || this._getColsFromMarkup() || this.columns;
            this.rows = opts.rows || this._loadItems() || this.rows;
        },
        searchFullText: function(filterValue, limit, orderCriteria) {
            if (!filterValue || filterValue.trim().length == 0) {
                this._loadItems({
                    "limit": limit,
                    "order": orderCriteria
                });

                return;
            }

            var filter = {"$or": []},
                self = this;

            for (var idx = 0; idx < this.columns.length; idx++) {
                var col = this.columns[idx],
                    clause = {};

                if (col.rel != "property") {
                    continue;
                }

                clause[col.id] = {"$contains": filterValue};

                filter["$or"].push(clause);
            }

            this._loadItems({
                "limit": limit,
                "order": orderCriteria,
                "where": filter
            });
        },
        _getColsFromMarkup: function() {
            var colElement = Polymer.dom(this).querySelector("bc-columns"),
                self = this,
                cols = [];

            $(colElement).find("div").each(function(idx, item) {
                item = $(item);

                var itemId = item.attr("data-id"),
                    itemName = item.attr("title"),
                    itemRel = item.attr("rel");

                if (itemRel == "property") {
                    cols.push({"id": itemId, "name": itemName, "template": "<span>{{getItemValue(item, col.id)}}</span>",
                                "rel": "property"});

                    return;
                }

                if (itemRel == "custom") {
                    cols.push({"template": item.html(), "name": itemName});
                }
            });

            colElement.remove();

            return cols;
        },
        _loadItems: function(opts) {
            var fetchOptions = {},
                self = this;

            opts = opts || {};

            if (opts.order && opts.order && opts.order != "0") {
                fetchOptions.order = opts.order;
            }

            if (opts.where) {
                fetchOptions.where = opts.where;
            }

            if (opts.limit) {
                fetchOptions.limit = opts.limit;
            }

            this._dataSource.fetchData(fetchOptions).done(function(data) {
                self._updateCurrentData(data);

            });
        },
        _updateCurrentData: function(data) {
            this.currData = data;
            this.configure({rows: data.items});            
        }
    };

    polymerObj = BCAPI.Components.ComponentsFactory.get(polymerObj);

    Polymer(polymerObj);
    </script>
</dom-module>