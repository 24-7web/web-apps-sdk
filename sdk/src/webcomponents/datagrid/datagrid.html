<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-datagrid">
    <template>
        <content></content>

        <template is="dom-if" if="{{visible}}">
        <div class="panel panel-default">
            <table class="table">
                <thead>
                    <tr>
                        <td colspan="{{columns.length}}">Displaying <span>{{rows.length}}</span> out of <span>{{currData.totalItemsCount}}</span> records.</td>
                    </tr>
                    <tr>
                    <template is="dom-repeat" items="{{columns}}" as="colItem">
                        <td>{{colItem.name}}</td>
                    </template>
                    </tr>
                </thead>

                <tbody>
                    <template is="dom-repeat" items="{{rows}}" as="itemRow" index-as="itemIndex">
                        <tr>
                            <template is="dom-repeat" items="{{columns}}" as="col">
                                <td>
                                    <bc-datagrid-customtpl item$="{{itemRow}}" col$="{{col}}" template$="{{col.template}}" contains-bindings></bc-datagrid-customtpl>
                                </td>
                            </template>
                        </tr>

                        <template is="dom-if" if="{{repeatedRow}}">
                            <tr>
                                <td colspan$="{{columns.length}}">
                                    <bc-datagrid-customtpl item$="{{itemRow}}" template$="{{repeatedRow}}" contains-bindings$></bc-datagrid-customtpl>
                                </td>
                            </tr>
                        </template>
                    </template>
                </tbody>
            </table>
        </div>
        </template>
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
    var webComponent = {
        is: "bc-datagrid",
        properties: {
            columns: Array,
            rows: Array,
            repeatedRow: String,
            apiName: String,
            apiVersion: String,
            visible: Boolean,
            dataSource: Object,
            dataVarname: String,
            bcConfig: Object,
            currData: {
                type: Object,
                readonly: true
            }
        },
        ready: function() {
            this._dataSource = Polymer.dom(this).querySelectorAll("*[rel='datasource']")[0];
        },
        configure: function(opts) {
            opts = opts || {};

            this.dataVarname = opts.dataVarname || this.dataVarname; 
            this.bcConfig = opts.bcConfig || this.bcConfig || {};
            this._dataSource = opts.dataSource || this._dataSource;

            if (this._dataSource) {
                this._dataSource.configure({"bcConfig": this.bcConfig});
            }

            this.columns = opts.columns || this._getColsFromMarkup() || this.columns;
            this.rows = opts.rows || this._loadItems() || this.rows;
        },
        display: function(visible) {
            this.visible = visible || false;
        },
        getItemAt: function(idx) {
            return this.rows[idx];
        },
        searchFullText: function(filterValue, limit, orderCriteria) {
            if (!filterValue || filterValue.trim().length == 0) {
                this._loadItems({
                    "limit": limit,
                    "order": orderCriteria
                });

                return;
            }

            var filter = {"$or": []},
                self = this;

            for (var idx = 0; idx < this.columns.length; idx++) {
                var col = this.columns[idx],
                    clause = {};

                if (col.rel != "property") {
                    continue;
                }

                clause[col.id] = {"$contains": filterValue};

                filter["$or"].push(clause);
            }

            this._loadItems({
                "limit": limit,
                "order": orderCriteria,
                "where": filter
            });
        },
        _getColsFromMarkup: function() {
            var colElement = Polymer.dom(this).querySelector("bc-columns"),
                self = this,
                cols = [];

            $(colElement).find("> div").each(function(idx, item) {
                item = $(item);

                var itemId = item.attr("data-id"),
                    itemName = item.attr("title"),
                    itemRel = item.attr("rel"),
                    itemTemplate = item.html().trim();

                if (itemRel == "property") {
                    if (!itemTemplate) {
                        itemTemplate = "<span>{{getItemValue(item,col.id)}}</span>";
                    }

                    cols.push({"id": itemId, "name": itemName, "template": itemTemplate,
                                "rel": "property"});

                    return;
                }

                if (itemRel == "custom-column") {
                    cols.push({"template": itemTemplate, "name": itemName});
                    
                    return;
                }

                if (itemRel == "custom-repeated-row") {
                    self.repeatedRow = itemTemplate;
                    return;
                }
            });

            return cols;
        },
        _loadItems: function(opts) {
            var fetchOptions = {},
                self = this;

            opts = opts || {};

            if (opts.order && opts.order && opts.order != "0") {
                fetchOptions.order = opts.order;
            }

            if (opts.where) {
                fetchOptions.where = opts.where;
            }

            if (opts.limit) {
                fetchOptions.limit = opts.limit;
            }

            this._dataSource.fetchData(fetchOptions).done(function(data) {
                self._updateCurrentData(data);
            });
        },
        _updateCurrentData: function(data) {
            this.currData = data;
            this.configure({rows: data.items});
        }
    };

    webComponent = BCAPI.Components.ComponentsFactory.get(webComponent);

    BCAPI.Components.DataGrid = Polymer(webComponent);
    </script>
</dom-module>