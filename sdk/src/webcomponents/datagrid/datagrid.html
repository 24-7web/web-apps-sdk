<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-datagrid"> 
    <style>
        .bc-datagrid-table {
            display: table;
            width: 100%;
        };
        .bc-datagrid-thead {
            display: table-header-group;
        };
        .bc-datagrid-tbody {
            display: table-row-group;
        };
        .bc-datagrid-tr {
            display: table-row;
        };
        .bc-datagrid-td {
            display: table-cell;
        };
        /* mimic bootstrap */
        :host .bc-datagrid-table > .bc-datagrid-thead> .bc-datagrid-tr:first-child > .bc-datagrid-td {
            border-top: 0;
        }
        :host .bc-datagrid-table > .bc-datagrid-thead > .bc-datagrid-tr > .bc-datagrid-td {
            padding: 8px;
            line-height: 1.42857143;
            vertical-align: top;
            border-top: 1px solid #ddd;
        }
        :host .bc-datagrid-table > .bc-datagrid-tbody > .bc-datagrid-tr > .bc-datagrid-td {
            padding: 8px;
            line-height: 1.42857143;
            vertical-align: top;
            border-top: 1px solid #ddd;
        }
        :host .bc-datagrid-hidden-tr {
            border: 0;
            display: table-row;
        };
    </style>
    <template>
        <content></content>

        <template is="dom-if" if="{{visible}}">
        <div class="panel panel-default">
            <div class="bc-datagrid-table table">
                <div class="bc-datagrid-thead">
                    <div class="bc-datagrid-tr">
                        <div class="bc-datagrid-td">Displaying <span>{{rows.length}}</span> out of <span>{{currData.totalItemsCount}}</span> records.</div>
                    </div>
                    <div class="bc-datagrid-tr">
                    <template is="dom-repeat" items="{{columns}}" as="colItem">
                        <div class="bc-datagrid-td">{{colItem.name}}</div>
                    </template>
                    </div>
                </div>

                <div class="bc-datagrid-tbody">
                    <template is="dom-repeat" items="{{rows}}" as="itemRow" index-as="itemIndex">
                        <div class="bc-datagrid-tr">
                            <template is="dom-repeat" items="{{columns}}" as="col">
                                <div class="bc-datagrid-td">
                                    <bc-datagrid-customtpl item$="{{itemRow}}" col$="{{col}}" template$="{{col.template}}" contains-bindings$></bc-datagrid-customtpl>
                                </div>
                            </template>
                        </div>

                        <template is="dom-if" if="{{repeatedRow}}">
                            <div class="bc-datagrid-hidden-tr">
                                <div class="bc-datagrid-td">
                                    <bc-datagrid-customtpl item$="{{itemRow}}" template$="{{repeatedRow}}" contains-bindings$></bc-datagrid-customtpl>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
        </div>
        </template>
    </template>

    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
    var webComponent = {
        is: "bc-datagrid",
        properties: {
            columns: Array,
            rows: Array,
            repeatedRow: String,
            apiName: String,
            apiVersion: String,
            visible: Boolean,
            dataVarname: String,
            bcConfig: Object,
            currData: {
                type: Object,
                readonly: true
            },
            _dataSource: {
                type: Object,
                notify: true
            },
            _expectsDataSource: {
                type: Boolean
            }
        },
        ready: function() {
            this._dataSource = Polymer.dom(this).querySelector("*[rel='datasource']");

            if (this._dataSource) {
                this._expectsDataSource = true;
            }
        },
        configure: function(opts) {
            opts = opts || {};

            this.dataVarname = opts.dataVarname || this.dataVarname; 
            this.bcConfig = opts.bcConfig || this.bcConfig || {};
            this._dataSource = opts.dataSource || this._dataSource;

            if (this._dataSource) {
                this._dataSource.configure({"bcConfig": this.bcConfig});
            }

            this.columns = opts.columns || this._getColsFromMarkup() || this.columns;
            this.rows = opts.rows || this._loadItems() || this.rows;
        },
        display: function(visible) {
            this.visible = visible || false;
        },
        getItemAt: function(idx) {
            return this.rows[idx];
        },
        searchFullText: function(filterValue, limit, orderCriteria) {
            if (!filterValue || filterValue.trim().length == 0) {
                this._loadItems({
                    "limit": limit,
                    "order": orderCriteria
                });

                return;
            }

            var filter = {"$or": []},
                self = this;

            for (var idx = 0; idx < this.columns.length; idx++) {
                var col = this.columns[idx],
                    clause = {};

                if (col.rel != "property") {
                    continue;
                }

                clause[col.id] = {"$contains": filterValue};

                filter["$or"].push(clause);
            }

            this._loadItems({
                "limit": limit,
                "order": orderCriteria,
                "where": filter
            });
        },
        _getColsFromMarkup: function() {
            var colElement = Polymer.dom(this).querySelector("bc-columns"),
                self = this,
                cols = [];

            $(colElement).find("> div").each(function(idx, item) {
                item = $(item);

                var itemId = item.attr("data-id"),
                    itemName = item.attr("title"),
                    itemRel = item.attr("rel"),
                    itemTemplate = item.html().trim();

                if (itemRel == "property") {
                    if (!itemTemplate) {
                        itemTemplate = "<span>{{getItemValue(item,col.id)}}</span>";
                    }

                    cols.push({"id": itemId, "name": itemName, "template": itemTemplate,
                                "rel": "property"});

                    return;
                }

                if (itemRel == "custom-column") {
                    cols.push({"template": itemTemplate, "name": itemName});
                    
                    return;
                }

                if (itemRel == "custom-repeated-row") {
                    self.repeatedRow = itemTemplate;
                    return;
                }
            });

            return cols;
        },
        _loadItems: function(opts) {
            var fetchOptions = {},
                self = this;

            opts = opts || {};

            if (opts.order && opts.order && opts.order != "0") {
                fetchOptions.order = opts.order;
            }

            if (opts.where) {
                fetchOptions.where = opts.where;
            }

            if (opts.limit) {
                fetchOptions.limit = opts.limit;
            }

            this._dataSource.fetchData(fetchOptions).done(function(data) {
                self._updateCurrentData(data);
            });
        },
        _updateCurrentData: function(data) {
            this.currData = data;
            this.configure({rows: data.items});
        }
    };

    webComponent = BCAPI.Components.ComponentsFactory.get(webComponent);

    BCAPI.Components.DataGrid = Polymer(webComponent);
    </script>
</dom-module>