<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="bc-api">
    <script type="text/javascript" src="/src/helper.js"></script>
    <script type="text/javascript" src="/src/webcomponents/components.js"></script>

    <script>
        var webComponent = {
            is: "bc-api",
            properties: {
                apiName: String,
                apiVersion: String,
                bcConfig: Object,
                fields: String
            },
            configure: function(opts) {
                this.bcConfig = opts.bcConfig;
            },
            fetchData: function(opts) {
                var data = ["fields=" + encodeURIComponent(this.fields)],
                    loader = $.Deferred();

                for (var key in opts) {
                    var optData = opts[key];

                    if (typeof optData !== "string") {
                        optData = JSON.stringify(optData);
                    }

                    data.push(key + "=" + encodeURIComponent(optData));
                }

                var response = $.ajax({
                    "url": this._getApiUrl(this.apiName, this.apiVersion),
                    "data": data.join("&"),
                    "headers": {
                        "Authorization": this.bcConfig.accessToken
                    }
                });

                response.done(function(data) {
                    loader.resolve(data);
                });

                return loader.promise();
            },
            _getApiUrl: function(apiName, apiVersion) {
                return [this.bcConfig.siteUrl, "/webresources/api/", apiVersion, "/sites/current/", 
                        apiName].join("");
            }
        };

        webComponent = BCAPI.Components.ComponentsFactory.get(webComponent);

        Polymer(webComponent);
    </script>
</dom-module>