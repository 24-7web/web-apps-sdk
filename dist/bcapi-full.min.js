!function($){"use strict";function authTokenReaderMissing(){return"25e793cc1a014e3e868e8a3fc50e182acd62888df0894a76852e2cd03aa20ece"}function requestEntity(entity,verb,uri,data,rawData){return request(verb,uri,data,rawData).then(function(data){return"object"===$.type(data)&&(entity.setAttributes?entity.setAttributes(data):entity.attributes=data),entity})}function fetchList(uri,paginator){return request("GET",uri).then(function(data){paginator=paginator||new Paginator;var Func=paginator.ItemConstructor;return Func&&(paginator.items=$.map(data.items,function(item){return paginator.owner?new Func(paginator.owner,item):new Func(item)}),delete data.items),$.extend(paginator,data)})}function after(times,func){return function(){return--times<1&&func?func.apply(this,arguments):void 0}}function chain(items,func){var promise=$.Deferred().resolve().promise();return $.each(items,function(i,item){promise=promise.then(func(item))}),promise}function notSupported(what){return function(){$.error(what+" is not supported by BC API.")}}window.BCAPI={},BCAPI.request=function(verb,uri,data,rawData){var options,token=BCAPI.authToken;if("object"==typeof verb?(options=verb,verb=options.type,uri=options.url,data=options.data,rawData=!0):options={type:verb},!uri)return(new $.Deferred).reject().promise();verb=(verb||"GET").toUpperCase(),BCAPI.log(verb+" "+uri),rawData||(options.contentType="application/json",data instanceof Paginator&&(data=data.items),data=data?JSON.stringify(data):data),options.data=data,uri.match(/https?:/)||("/"!==uri.charAt(0)&&(uri="/api/v2/admin/sites/current/"+uri),uri="https://"+BCAPI.apiHost+uri),options.url=uri,options.headers=$.extend({Authorization:$.isFunction(token)?token(useGenericToken?"genericAuthToken":"siteAuthToken"):token},options.headers);var jqXHR=jQuery.ajax(options);return jqXHR.then(function(data,status,xhr){var location=xhr.getResponseHeader("Location");return location&&!data?request("GET",location):data}).promise(jqXHR)};var request=BCAPI.request;BCAPI.debug=!0,BCAPI.log=function(msg){window.console&&BCAPI.debug&&console.log("BCAPI: "+msg)},BCAPI.authToken=$.cookie?$.cookie:authTokenReaderMissing,BCAPI.apiHost=top.authData?top.authData.apiUrl:"bc-local.worldsecuresystems.com";var useGenericToken=!1,FactoryCRUD={uri:function(){$.error("FactoryCRUD.uri() not implemented")},create:function(attributes){return requestEntity(new this(attributes),"POST",this.uri(),attributes)},list:function(){return fetchList(this.uri(),new Paginator(this))},get:function(id){return new this({id:id}).fetch()}},EntityBase={attributes:void 0,links:void 0,linkUri:function(name){if(this.links)for(var i=0;i<links.length;i++)if(this.links[i].rel===name)return this.links[i].uri},setAttributes:function(attr){return attr=attr||{},this.links=attr.links,delete attr.links,this.attributes=attr,this}},EntityCRUD=$.extend({uri:function(){$.error("EntityCRUD.uri() not implemented")},request:function(verb,data,rawData){return requestEntity(this,verb,this.uri(),data,rawData)},fetch:function(){return this.request("GET")},save:function(){return this.request("PUT",this.attributes)},remove:function(){return this.request("DELETE")}},EntityBase),Paginator=BCAPI.Paginator=function(ItemConstructor,owner,items){this.items=items||[],this.owner=owner,this.ItemConstructor=ItemConstructor};$.extend(Paginator.prototype,{items:void 0,totalItemsCount:void 0,links:void 0,owner:void 0,ItemConstructor:void 0,linkUri:EntityBase.linkUri,fetchCurrPage:function(){return fetchList(this.linkUri("self"),this)},fetchNextPage:function(){return fetchList(this.linkUri("next"),this)},fetchPreviousPage:function(){return fetchList(this.linkUri("previous"),this)},fetchItems:function(){var paginator=this;return $.Deferred(function(deferred){if(!paginator.items||!paginator.items.length)return deferred.resolve(),void 0;var callback=after(paginator.items.length,function(){deferred.resolve()});$.each(paginator.items,function(i,item){item.fetch().done(callback).fail(deferred.reject)})}).promise()}});var BCFile=BCAPI.File=function(path,attributes){"/"!==path.charAt(0)&&(path="/"+path),this.path=path,this.setAttributes(attributes)};$.extend(BCFile,{create:function(path,content){var file=new this(path);return file.write(content).then(function(){return file.fetch()})},get:function(path){return new this(path).fetch()},root:function(){return this.get("")}}),$.extend(BCFile.prototype,EntityCRUD,{contentUri:function(){return"storage"+this.path},uri:function(){return this.contentUri()+"?meta"},draftUri:function(){return this.contentUri()+"?version=draft"},setAttributes:function(attributes){if(delete this.files,attributes&&"folder"===attributes.type){var folder=this;folder.files=$.map(attributes.contents,function(fileAttr){return new BCFile(folder.path+"/"+fileAttr.name,fileAttr)})}return EntityBase.setAttributes.call(this,attributes)},remove:function(force){return requestEntity(this,"DELETE",this.contentUri()+"?force="+!!force)},removeDraft:function(){return requestEntity(this,"DELETE",this.draftUri()+"?force="+!!force)},read:function(){return requestEntity(this,"GET",this.contentUri(),null,!0)},readDraft:function(){return requestEntity(this,"GET",this.draftUri(),null,!0)},write:function(contents){return requestEntity(this,"PUT",this.contentUri(),contents,!0)},writeDraft:function(contents){return requestEntity(this,"PUT",this.draftUri(),contents,!0)}});var WebApp=BCAPI.WebApp=function(attributes){this.setAttributes(attributes)};$.extend(WebApp,FactoryCRUD,{uri:function(){return"webapps"},get:function(name){return new this({name:name}).fetch()},createFromSchema:function(schema){var webApp,categoriesMap;return BCAPI.log("Create missing Categories..."),Category.createPathRecursive($.map(schema.categories,function(count,path){return path})).then(function(map){return categoriesMap=map,BCAPI.log("Create WebApp..."),WebApp.create(schema.webApp.attributes)}).then(function(wa){return webApp=wa,BCAPI.log("Assign countries..."),schema.countries&&schema.countries.length?webApp.saveCountries(schema.countries):webApp}).then(function(){return BCAPI.log("Create fields..."),chain(schema.webApp.fields,function(field){return WebAppField.create(webApp,field.attributes)})}).then(function(){return BCAPI.log("Create items and assign categories..."),chain(schema.items,function(item){return WebAppItem.create(webApp,item.attributes).then(function(itemEntity){var categoryIds=$.map(item.categories,function(path){return categoriesMap[path].attributes.id});return itemEntity.saveCategories(categoryIds)})})}).then(function(){return BCAPI.log("Done."),webApp})},exportSchema:function(name){var mapCategoryIdToPath,schema={};return BCAPI.log("List Categories..."),Category.listWithFullPath().then(function(mapPathToObject,mapIdToPath){return mapCategoryIdToPath=mapIdToPath,BCAPI.log("Get WebApp schema..."),WebApp.get(name)}).then(function(webApp){schema.webApp=webApp,$.each(webApp.fields,function(i,field){delete field.links,delete field.webApp}),delete webApp.links;var webAppAttr=webApp.attributes;return delete webAppAttr.id,delete webAppAttr.createBy,delete webAppAttr.createDate,delete webAppAttr.itemSystemFields,delete webAppAttr.lastUpdateBy,delete webAppAttr.lastUpdateDate,BCAPI.log("Get WebApp countries..."),webApp.getCountries()}).then(function(countries){return schema.countries=countries.items,BCAPI.log("Get WebApp items..."),WebAppItem.list(schema.webApp,"limit=100")}).then(function(paginatedItems){return $.Deferred(function(deferred){schema.items=paginatedItems.items;var categoriesDoneCallback=after(schema.items.length,function(){deferred.resolve(schema)});BCAPI.log("Get items' categories..."),schema.categories={},$.each(schema.items,function(i,item){item.getCategories().fail(deferred.reject).done(function(categories){item.categories=$.map(categories.items,function(categoryId){var path=mapCategoryIdToPath[categoryId];return schema.categories[path]=(schema.categories[path]||0)+1,path}),categoriesDoneCallback()}),delete item.links,delete item.webApp;var itemAttr=item.attributes;delete itemAttr.id,delete itemAttr.createDate,delete itemAttr.lastUpdateDate})}).promise()})},importFromFile:function(filename){return BCAPI.log('Importing WebApp from file "'+filename+'"...'),"/"!==filename.charAt(0)&&(filename="/Layouts/WebApps/"+filename+"/schema.json"),new BCFile(filename).read().then(function(schema){return WebApp.createFromSchema($.parseJSON(schema))})},importFromFiles:function(filenames){var webApps={};return chain(filenames,function(filename){return WebApp.importFromFile(filename).done(function(webApp){webApps[filename]=webApp})}).done(function(){return webApps})},exportToFile:function(webAppName,filename){return BCAPI.log("Exporting WebApp "+webAppName+'"...'),WebApp.exportSchema(webAppName).then(function(schema){return filename=filename||"/Layouts/WebApps/"+schema.webApp.attributes.name+"/schema.json",new BCFile(filename).write(JSON.stringify(schema))})}}),$.extend(WebApp.prototype,EntityCRUD,{uri:function(){return WebApp.uri()+"/"+this.attributes.name},countriesUri:function(){return this.uri()+"/countries"},save:notSupported("WebApp.save()"),"delete":notSupported("WebApp.delete()"),getCountries:function(){return fetchList(this.countriesUri())},saveCountries:function(countries){return request("PUT",this.countriesUri(),countries)},setAttributes:function(attributes){if(delete this.fields,attributes&&attributes.fields){var webApp=this;webApp.fields=$.map(attributes.fields,function(fieldAttr){return new WebAppField(webApp,fieldAttr)}),delete attributes.fields}return EntityBase.setAttributes.call(this,attributes)}});var WebAppField=BCAPI.WebAppField=function(webApp,attributes){this.webApp=webApp,this.setAttributes(attributes)};$.extend(WebAppField,{uri:function(webApp){return webApp.uri()+"/fields"},create:function(webApp,attributes){return requestEntity(new this(webApp,attributes),"POST",this.uri(webApp),attributes)},list:function(webApp){return fetchList(this.uri(webApp),new Paginator(this,webApp))},get:function(webApp,id){return new this(webApp,{id:id}).fetch()}}),$.extend(WebAppField.prototype,EntityCRUD,{uri:function(){return WebAppField.uri(this.webApp)+"/"+this.attributes.id}});var WebAppItem=BCAPI.WebAppItem=function(webApp,attributes){this.webApp=webApp,this.setAttributes(attributes)};$.extend(WebAppItem,{uri:function(webApp){return webApp.uri()+"/items"},create:WebAppField.create,get:WebAppField.get,list:function(webApp,query){var uri=this.uri(webApp);return query&&(uri+="?"+("object"==typeof query?$.param(query):query)),fetchList(uri,new Paginator(this,webApp))}}),$.extend(WebAppItem.prototype,EntityCRUD,{uri:function(){return WebAppItem.uri(this.webApp)+"/"+this.attributes.id},categoriesUri:function(){return this.uri()+"/categories"},getCategories:function(){return fetchList(this.categoriesUri())},saveCategories:function(categories){return request("PUT",this.categoriesUri(),categories)}});var Category=BCAPI.Category=function(attributes){this.setAttributes(attributes)};$.extend(Category,FactoryCRUD,{uri:function(){return"categories"},createPathRecursive:function(path,map){if(!map)return this.listWithFullPath().then(function(map){return Category.createPathRecursive(path,map)});if($.isArray(path))return chain(path,function(p){return Category.createPathRecursive(p,map)}).then(function(){return map});var category=map[path];if(category)return $.Deferred().resolve(category).promise();var parentPath=path.replace(/\/[^\/]+$/,""),name=path.replace(/.*\//,"");return parentPath?Category.createPathRecursive(parentPath,map).done(function(parentCategory){return Category.create({name:name,parentId:parentCategory.attributes.id}).done(function(category){map[path]=category})}):Category.create({name:name}).done(function(category){map[path]=category})},listWithFullPath:function(){return $.Deferred(function(deferred){Category.list().fail(deferred.reject).done(function(categories){function map(path,category){mapIdToPath[category.attributes.id]=category.attributes.fullPath=path,mapPathToObject[path]=category}var mapIdToPath={},mapPathToObject={};$.each(categories.items,function(i,category){var attrs=category.attributes;if(-1===attrs.parentId){var path="/"+attrs.name;map(path,category)}});for(var l=0;2>l;l++)$.each(categories.items,function(i,category){var attr=category.attributes;if(!mapIdToPath[attr.id]&&mapIdToPath[attr.parentId]){var path=mapIdToPath[attr.parentId]+"/"+attr.name;map(path,category)}});deferred.resolve(mapPathToObject,mapIdToPath)})}).promise()}}),$.extend(Category.prototype,EntityCRUD,{uri:function(){return Category.uri()+"/"+this.attributes.id},save:notSupported("Category.save()"),"delete":notSupported("Category.delete()")});var Country=BCAPI.Country=function(attributes){this.setAttributes(attributes)};$.extend(Country,{uri:function(){return"/api/v2/admin/system/countries"},list:FactoryCRUD.list,listForIp:function(ip){return fetchList(this.uri()+"?ip="+(ip||"current"),new Paginator(Country))}}),$.extend(Country.prototype,EntityBase);var Role=BCAPI.Role=function(attributes){this.setAttributes(attributes)};$.extend(Role,{uri:function(){return"roles"},list:FactoryCRUD.list}),$.extend(Role.prototype,EntityBase);var Template=BCAPI.Template=function(attributes){this.setAttributes(attributes)};$.extend(Template,{uri:function(){return"templates"},list:FactoryCRUD.list}),$.extend(Template.prototype,EntityBase);var Site=BCAPI.Site=function(attributes){this.setAttributes(attributes)};$.extend(Site,{list:function(){useGenericToken=!0;var list=fetchList("/api/v2/admin/sites",function(attr){return new Site(attr)});return useGenericToken=!1,list},current:function(){requestEntity(new this,"GET","/api/v2/admin/sites/current")}}),$.extend(Site.prototype,EntityBase)}(jQuery);